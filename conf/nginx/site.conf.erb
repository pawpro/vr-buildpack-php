# Default configuration for non-framework apps
root /app/<%= ENV['DOCUMENT_ROOT'] %>;

map $http_x_forwarded_proto $my_https {
    default off;
    https on;
}

location = /favicon.ico {
    empty_gif;
}

location ~* ^/opi/js/[a-z_\-]+.[0-9a-f]+.min {
    rewrite ^/opi/js/([a-z_\-]+)\.[0-9a-f]+.min.js /opi/js/$1.min.js;
}

location ~ ^/opi/(images|js|css)/ {
    rewrite ^/opi/(.*) /$1;
}

location ~ ^/opi/scheduled {
    allow 127.0.0.1;
    deny all;
}

location ~ ^/(images|js|css)/ {
    expires         max;
    add_header      Pragma public;
    add_header      Cache-Control "public, must-revalidate, proxy-revalidate";
    log_not_found off;
}

location /server-status {
    allow 127.0.0.1;
    deny all;
    
    stub_status on;
    access_log   off;
}

location /opi {
    rewrite ^/opi(/.*)$ $1;
}

location / {
    rewrite ^/(.*) /index.php;
}

location = /index.php {
    include fastcgi_params;
    fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;
    fastcgi_param   HTTPS $my_https if_not_empty;
    fastcgi_param   HTTP_X_FORWARDED_PROTO "https";
    fastcgi_buffers 256 4k;
    fastcgi_pass php;
}